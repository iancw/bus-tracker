\documentclass[12pt]{report}

\usepackage{graphicx}
\usepackage{enumerate}
\usepackage{listings}
\usepackage[titletoc]{appendix}

\usepackage{url}
\usepackage[bibstyle=ieee]{biblatex}
\setcounter{tocdepth}{3}

\lstMakeShortInline|
%\linespread{1.6}

\makeatletter
\def\@makechapterhead#1{%
  \vspace*{50\p@}%
  {\parindent \z@ \raggedright \normalfont
    %\ifnum \c@secnumdepth >\m@ne
    %    \huge\bfseries \@chapapp\space \thechapter
    %    \par\nobreak
    %    \vskip 20\p@
    %\fi
    \interlinepenalty\@M
    \Huge \bfseries #1\par\nobreak
    \vskip 40\p@
  }}
  \makeatother

\bibliography{final-report}

\title{Bus Tracker: Final Report}

\author{Ian Will, Jason Cluck}
\date{}

\begin{document}
\maketitle

\tableofcontents
\listoffigures

\chapter{Introduction and Motivation}

  Public transportation in the District of Columbia is critical to many of its residents and employees.  The District's public transporation is managed by the Washington Metro Area Transit Authority (WMATA).  WMATA maintains a system of rail and buses that serve most location in the district.  The WMATA rail system is simpler than the bus network and has many maps that are useful for discovering which rail lines server particular regions.  The bus system serves more locations that rail, but can be significantly more perplexing for a new rider.  There are a large number of routes and no comprehensive map, and buses rarely adhere to posted schedules.

\section{Problem Statement}

The Bus Tracker web application provides an interactive map-based overview of the WMATA bus system.  It uses a web API provided by  WMATA to query current bus locations, predictions of arrival times at stops, and full listings of route and stop locations.  This information is then displayed in a clear and interactive manner that displays high-level overviews with easy drill-down for pertinent details (as encouraged by Edward Tufte \cite{tufte:2006}).

\chapter{Requirements Analysis}

\section{Use Cases}

The application is intended for use by those considering or planning to travel on the WMATA bus system.  The primary use case is a smart phone user considering how to catch a bus to an intended destination.  Someone in that situation wonders how long they will be waiting for a bus to arrive at the nearest stop.  They may like to consider alternatives to the bus system such as rail, taxi, or alternate bus route depending on how long they will need to wait for a bus.  They may also like to use Google's traffic overlay to estimate how long the bus will be delayed.

The application will help by showing the anticipated time until the next bus arrives, showing where the next arriving bus is going, and showing nearby stops and routes that may be equally suitable for the intended destination.  This person will probably make location information available to the application through their browser.  The web application may use this information to filter routes and buses that are display to improve performance.  It may also use the location to suggest alternate routes with more promptly ariving buses. 

A second use case is someone at their home or desk computer considering when to leave to minimize wait time at a stop without missing a bus.  The concerns in this case will be similar to to the concerns of the smart-phone user, but location data may not be available.  The person may want a reminder when they need to leave in order to catch their bus.
  

\section{Threshold Requirements}
Threshold requirements describe the minimal set of functionality for a usable product.  These are the requirements that we plan to accomplish.
\begin{enumerate}
\item Display a map of the DC metro region in a web browser
\item Display the browser's reported location on the map if current location is available from the browser
\item Display all WMATA bus routes on the map
\item Display the current locations of all WMATA buses on the map
\item Visually indicate bus direction along with bus position displays
\item Display bus routes using different colors to visually differentiate routes
\item Display bus positions using the same color used for its route
\item Update bus position markers with current positions at five second intervals
\item Display bus stop locations on the map
\item Display the following detail information about a bus stop by clicking on the stop marker
\begin{enumerate}
\item Display the anticipated wait time for the next bus for each route that intersects a given stop
\end{enumerate}
\item Display the following detail information about a bus by clicking on the bus marker
\item Display the stop's WMATA id number
\item Display all bus routes that serve the stop
\begin{enumerate}
\item Bus route name (e.g. ``5A'')
\item Bus headsign (e.g. ``DULLES AIRPORT'')
\item Bus direction (e.g. ``WEST'')
\item Positional uncertainty circle around the bus marker
\end{enumerate}
\end{enumerate}


\section{Objective Requirements}
Objective requirements describe functionality that would improve the quality or usefulness of the application, but are not strictly necessary for a useful product.  These are things we would like to accomplish, but are unsure if time will allow.
\begin{enumerate}
\item Draw DC Circulator bus positions and routes (DC Circulator is not part of the WMATA system)
\item Provide filtering to limit the displayed buses and routes
\begin{enumerate}
\item Filter by only showing routes, stops, and buses matching a route name
\item Filter by only showing routes, stops, and buses matching a headsign
\item Filter by only showing routes with stops wihtin some proximity to the device's current location 
\item Filter by only showing routes with stops wihtin some proximity to an arbitrary location
\item Combine filters using boolean logic, for example only showing routes with stops near current location and some arbitrary location
\end{enumerate}
\item Send a text message or email reminder when a bus is some number of minutes away from a stop
\end{enumerate}

\chapter{Design}

The project to create a live map of DC's Washington Metro Area Transit Authority (WMATA) bus system will be built using the Ruby on Rails web framework, the Google Maps API, WMATA's Transparent Data Sets API, and Twitter's Bootstrap CSS API.

The Google Maps API is used to display the background map, route paths, and bus marker overlays.  Figure \ref{fig:designOverview} shows an overview for how these APIs connect to the Rails web server we're building.

\begin{figure}[ht]
  \centerline{\includegraphics[scale=0.6]{design.png}}
  \caption{API integration overview}
  \label{fig:designOverview}
\end{figure}

The Rails design philosophy favors adopting standard conventions for naming, folder structure, and design patterns across all Rails applications.   This accelerates web development, saving a lot of configuration and rudimentary structuring and naming decision when starting a project.  It also allows the framework to provide numerous helper tools that automate as much as possible.


\section{Model-View-Controller}
The fundamental design pattern adopted by Rails is Model-View-Controller (MVC).  The premise behind MVC is to separate user-interface code (the View), data structures (the Model), and the business logic that connects them (the Controller) into separate modules that can be developed, unit tested, and maintained in isolation.  Figure \ref{fig:MVC} shows the MVC separation as used in the Bus Tracker application.

\begin{figure}[ht]
  \centerline{\includegraphics[width=\textwidth]{busTrackerUML.png}}
  \caption{MVC control pattern}
  \label{fig:MVC}
\end{figure}

When an HTTP request comes to the HTTP Server, it first goes to the rails router, which determines which Controller should handle that request.  The controller then uses the Model classes to get the current state of data (e.g. the current position of buses from the database), and passes that information to the View classes.  Rails stores the View logic as HTML with additional preprocessor directives for special scripts called ``partials'' including Embedded Ruby and CoffeeScript.  When these partials are processed by the appropriate preprocessor engine, they have access to variables and data structures provided by the controller.  The preprocessor engine dynamically generates standard HTML and Javascript based on the partial scripts and the data provided by the controller.  These conventions and tools make it easy to prevent business logic from creeping into view code.  They provide a standard idiom for passing data between the model, controller, and view.

Rails adopts the Representational State Transfer (REST) architecture for the HTTP interface.  It uses the inherent HTTP methods (GET, POST, PUT, DELETE) to execute the corresponding Create, Read, Update, Destroy (CRUD) operations on the data model.  This approach is contrasted by the alternative (non-REST) approach of relying predominantly on the HTTP GET method and controlling CRUD behavior using special parameters embedded in the URI.  Our Bus Tracker application doesn't provide a user-facing capability to create, update, or destroy the model since model updates are fetched from WMATA servers rather than driven by user input.  Therefore the POST, PUT, and DELETE routes have no action associated with them in the controller.  

The GET requests retrieve different types of data depending on the URI requested.  Requesting the root (GET / or GET /index.html) provides the overview map display.  Requesting \lstinline|GET /buses| or GET /buses.json returns the current state of the buses model.  Request GET /stops requests data purely on the stops.  These likely won't be used directly by users, but they are used in the Javascript that asynchronously updates the map display.  Periodically a Javascript request is made to /buses.json to retrieve an updated array of bus positions in the JSON format.  

Some of the API features specific to Bus Tracker are listed in Figure \ref{fig:MVC}.  The controller relies on fetching data from the WMATA servers which  are accessed via a helper class - WmataHelper.  WmataHelper fetches the current position of all buses from the WMATA servers and stores that data in using the model classes. 

 Bus Tracker also uses is Twitter's Bootstrap API which provides additional CSS options. Combining Bootstrap with the View can create dynamic web pages that can render correctly on phones or desktop computers with minimal overhead.

\section{Model Relationships}

Bus Tracker will contain information regarding all the buses served by WMATA.  This includes bus information (including positions), stop information, and route information (including way points describing the route).  Figure \ref{fig:busEntity} shows the entities and relationships between the WMATA data used by Bus Tracker.  This is the information that will be stored locally after retrieving the information from WMATA.

\begin{figure}[ht]
  \centerline{\includegraphics[scale=0.43]{bus-entity-rel.png}}
  \caption{Model relationship diagram}
  \label{fig:busEntity}
\end{figure}

Figure \ref{fig:busSchema} shows the schema that Bus Tracker uses to store information about the current state of the WMATA bus system.  This persists all necessary information on routes, buses, and stops.  Underlined fields indicate primary keys, arrows indicate foreign key dependencies on primary keys from other tables.  

\begin{figure}[ht]
  \centerline{\includegraphics[scale=0.6]{bus-schema.png}}
  \caption{Schema for WMATA API}
  \label{fig:busSchema}
\end{figure}


\chapter{Implementation Details}

\chapter{Test Cases}


\chapter{Task Breakdown and Timeline}
\begin{description}
  \item Tasks to be done by:  November 10, 2012   
  
  \begin{enumerate}
    \item Initial rails setup [Cluck]
    \item CSS styling using twitter bootstrap [Cluck]
    \item Display map on index page [Cluck]
    \item Fetch bus positions from WMATA servers [Will]
    \item Store WMATA response in database [Will]
    \item Draw markers on map for bus locations [Will]
    \item Draw lines on map for bus routes [Will]
    \item Display initial map area based on geo-location reading [Cluck]
    \item Show info window when bus marker is clicked, including the following [Will]
    \begin{enumerate}
      \item Route name
      \item Schedule deviation (lateness)
      \item Time of last position update (data staleness)
      \item Headsign
      \item Direction
    \end{enumerate}
  \end{enumerate}
  \item Tasks to be done by: November 20, 2012
  \begin{enumerate}
    \item Fetch routes from WMATA servers [Will]
    \item Fetch stops from WMATA servers [Will]
    \item Store routes in database [Cluck]
    \item Store stops in database [Cluck]
  \end{enumerate}
  \item Tasks to be done by: December 3, 2012
  \begin{enumerate}
    \item Display bus stops with markers on map [Cluck]
    \item Control WMATA polling to avoid exceeding usage limits [Will]
    \item Show info window when stop marker is clicked [Will]
      \begin{enumerate}
        \item Show which routes and directions the use the stop
        \item Show next bus wait time projections for each route that uses the stop
      \end{enumerate}
    \item Show info window when stop marker is clicked [Will]
    \begin{enumerate}
      \item Retrieve HTML from Rails stops/:id path
      \item Use AJAX to update next bus arrival predictions from WMATA
    \end{enumerate}
    \item Orient bus markers according to direction traveled
  \end{enumerate}
\end{description}

\addcontentsline{toc}{chapter}{References}
\printbibliography

\begin{appendices}
\chapter{User Manual}



\end{appendices}


\end{document}

